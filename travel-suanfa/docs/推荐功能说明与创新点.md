# 非遗推荐功能说明与创新点

## 一、推荐功能如何实现

### 1. 整体流程

用户请求（位置、兴趣标签、天气等）→ 从 MySQL 拉取候选项目与商户 → 按五类因子加权打分 → 排序取 Top N 返回。

### 2. 数据与召回

- **数据源**：MySQL 的 `ich_project`（非遗项目）、`merchant`（商户）。
- **地理过滤**：以用户经纬度为中心，±0.5°（约 50 公里）范围内的项目与商户才进入候选。
- **非遗项目**：仅 `open_status = '1'` 的开放项目参与推荐。

### 3. 打分逻辑（五因子加权）

对每个候选项计算综合分，权重可在配置中调整，默认如下：

| 因子 | 权重 | 实现要点 |
|------|------|----------|
| **距离** | 30% | Haversine 球面距离，越近分数越高，超过 50km 剔除。 |
| **兴趣匹配** | 25% | 兴趣标签与项目类别匹配；可选接入向量化服务做语义相似度。 |
| **历史行为** | 20% | 从 `user_behavior` 读取该用户对项目/商户的浏览、点击等，归一化后加权。 |
| **天气适配** | 15% | 晴/雨等与室内外属性结合，配置表调节室内/室外加成。 |
| **热度/评分** | 10% | 使用项目/商户的评分或热度作为补充分。 |

各因子得分乘以权重后相加得到总分，按总分降序取前 N 条作为推荐结果。

**距离计算**采用 Haversine 公式，按地球球面两点经纬度算实际公里数，避免平面近似误差；超出配置的最大距离（默认 50km）的候选直接剔除，不参与打分。**兴趣匹配**除标签与类别字符串匹配外，可接入外部向量化服务：请求若带意图向量或用户兴趣向量，会与项目向量做余弦相似度，取“标签匹配得分”与“语义相似度”的较大值，兼顾显式偏好与隐式语义。**天气适配**在配置中为每种天气（晴、多云、阴、小雨、中雨、大雨、暴雨）设定室内/室外加成系数，例如晴天对室外项目加分、暴雨对室内加分，再结合项目的 `is_indoor` 属性得到天气因子得分。**历史行为**从 `user_behavior` 表按用户 ID 统计对某项目/商户的浏览、点击、收藏等次数，归一化到 0～1 后作为该因子得分，体现“看过、点过的更可能再推荐”。

### 4. 对外接口

- **POST /api/recommend**：入参为 userId、lat、lng、interestTags、weather、outdoorSuitable、limit；返回推荐列表及 total。
- **POST /api/embedding**：文本向量化，供语义匹配使用（可选）。
- **POST /api/feedback**：上报用户反馈（点击、浏览、收藏等），供强化学习使用。

---

## 二、创新点

### 1. 强化学习与多因子融合

在固定权重多因子推荐之上，增加 **LinUCB 上下文多臂老虎机**，根据“当前用户+上下文”的状态，**动态调整**上述五类因子的权重，而不是始终用同一套权重，实现**因人、因场景**的权重分配。传统推荐往往用一套固定权重（如距离 30%、兴趣 25%），无法区分“周末出游用户”与“工作日附近体验用户”、也无法随反馈迭代；本系统在每次推荐前用 LinUCB 根据当前状态输出一组权重，再交给多因子打分模块使用，从而在**不改变打分公式**的前提下，让权重随状态与反馈演化，兼顾可解释性与自适应能力。

### 2. 状态建模（State）

将“当前请求+用户”抽象为 **50 维状态向量**，包括：

- 用户侧：平均浏览时长、点击率、转化率、偏好类别、平均距离等（约 10 维）。
- 上下文：经纬度、天气、是否适宜户外、时段、是否周末等（约 15 维）。
- 兴趣：当前请求的兴趣标签编码（约 25 维）。

状态向量作为 LinUCB 的输入，用于选择“当前状态下更优的权重组合”。用户侧特征从 `rl_user_state` 表或缓存读取，新用户无历史时用默认值（如点击率 0、偏好类别空）；上下文中的天气、经纬度、是否周末等用于区分“室内偏好场景”与“户外偏好场景”；兴趣标签经编码后补齐到固定维度，保证每次请求的状态向量维度一致（50 维），便于矩阵运算。这种设计使“同一用户在不同时间、不同地点、不同天气”会得到不同的状态向量，从而触发不同的权重组合，实现细粒度适配。

### 3. 动作与奖励（Action & Reward）

- **动作**：对五类推荐因子权重的调整。LinUCB 输出的是“利用已有经验 + 适度探索”后的权重组合，直接作用于本次推荐打分。实现上，学到的参数 θ 通过简化映射转为五因子权重的微调量，在默认权重基础上做加减，保证权重仍为正且总和合理，避免极端分配。
- **奖励**：来自用户反馈接口。点击、浏览时长、收藏、访问、购买等行为转化为奖励；用户反馈后异步更新该次推荐对应的交互记录奖励，并驱动模型参数更新。高价值行为（如访问、购买）可设更高奖励，点击、浏览次之，形成显式信号，使模型逐步偏向“能带来深度参与”的权重组合。

### 4. 在线学习（LinUCB 更新)

- **选择**：UCB = θᵀx + α√(xᵀA⁻¹x)，即“利用项 + 探索项”，得到当前状态下的权重调整方案。其中 θ = A⁻¹b 为当前估计的线性参数，θᵀx 表示在状态 x 下的期望收益（利用）；α√(xᵀA⁻¹x) 为探索项，对“历史数据较少覆盖的状态方向”给予更高上界，避免过早收敛到次优权重。α 为探索系数，可在配置中调节。
- **更新**：收到反馈后，用该次的状态向量 x 与奖励 r，按公式更新矩阵 A（A ← A + xxᵀ）和向量 b（b ← b + r·x），实现**在线、增量**学习，无需离线重训。A 初始为单位矩阵、b 为全零，随反馈累积；矩阵不可逆时使用伪逆保证数值稳定。这样每次用户反馈都会立刻反映到下一轮推荐中，适合非遗场景下数据逐步积累、策略持续优化的需求。

### 5. 闭环与数据流

- 推荐时：生成 session_id，提取状态、调用 LinUCB 得到权重 → 用该权重做多因子打分 → 返回结果，并异步落库交互记录（状态、动作、推荐列表）。交互表保存当次的状态向量、采用的权重、返回的推荐 ID 等，便于反馈时反查并更新奖励。
- 反馈时：写入反馈表，根据 session_id 关联到当次交互，异步更新奖励并更新 LinUCB 的 A、b。前端在用户点击、收藏等时调用 `/api/feedback` 并传入该次推荐返回时记录的 session_id（可从服务端日志或后续扩展的响应字段获取），即可形成“推荐—反馈—更新”闭环。
- 支持**用户级**与**全局**模型：优先用“用户:userId”模型，缺失时回退到全局模型，兼顾个性化与冷启动。新用户或低活用户直接使用全局 A、b，避免数据稀疏导致的不稳定；活跃用户逐步积累个人模型，实现个性化权重演化。

---

## 三、小结
采用“多因子打分 + LinUCB 在线学习”的混合架构：每次推荐请求到达后，先根据用户与上下文构建 50 维状态向量，再基于当前模型参数（A、b）计算 UCB 上界并得到五因子权重的调整量，继而用该权重对候选项目与商户进行距离、兴趣、历史、天气、热度五因子加权打分并排序返回；同时异步落库当次交互（状态、动作、推荐列表）并生成 session_id。用户在前端产生点击、收藏等行为时，通过反馈接口上报 session_id 与行为类型，服务端据此计算奖励、按 LinUCB 公式增量更新 A 与 b，从而使下一轮推荐在相同或相似状态下采用更新后的权重，形成“状态→动作→展示→反馈→更新”的闭环。技术栈上，推荐与 RL 由 Python（FastAPI）实现，MySQL 存储业务表与 RL 表，可配置关闭 RL 退化为纯多因子推荐；整体在保持“为什么推”可解释的前提下，实现权重随反馈的在线优化与场景适配。
