import{d as ke,r as u,I as O,o as Ee,c as _,b as l,w as n,E as we,J as xe,f as Ae,h as Le,i as Me,j as Pe,K as De,L as x,M as A,k as ze,B as f,N as Re,l as r,e as V,t as je,O as $,v as Te,P as q,Q as Be,R as Fe,A as Oe,S as ie,T as $e,D as G,U as qe,V as Ge,W as He,X as Ke,x as Ne,z as Ye,Y as Je,Z as Qe,m as b,$ as We,a0 as Xe,p as c,a1 as Ze,_ as ea}from"./index-Bh04lDP-.js";/* empty css                   */import{g as aa,a as ta,u as de,d as la}from"./ich-Dffa0FPv.js";/* empty css               *//* empty css                    *//* empty css                        *//* empty css                 *//* empty css                *//* empty css                     */import{A as na,g as se,a as oa}from"./index-CSyRSZWU.js";const ia={class:"app-container"},da={class:"toolbar"},sa={class:"image-slot"},ra={class:"pagination"},ua=["src"],pa="ae49d6da7c2b2e512cfd0eee52a8e84a",ca="b53b60a2ff86751a31550af6a570fc7b",ma=ke({__name:"index",setup(fa){const D=u(!1),h=u([]),H=u(0),K=u([]),m=O({}),s=O({current:1,pageSize:10,name:"",city:"",category:""}),C=u(!1),z=u("add"),R=u(!1),j=u(),o=O({id:void 0,name:"",category:"",city:"",description:"",imageUrl:"",isIndoor:0,openStatus:"open",lat:void 0,lng:void 0,merchantIds:[]}),L=u(null),I=u(!1),M=u(!1),S=u({}),g=u([]),U=u([]),N=["传统美术","传统技艺","传统戏剧","传统舞蹈","民俗"],Y=["广州市","佛山市","深圳市","东莞市"],re={name:[{required:!0,message:"请输入项目名称",trigger:"blur"}],category:[{required:!0,message:"请选择类别",trigger:"change"}],city:[{required:!0,message:"请选择城市",trigger:"change"}]};let k=null;const J=async()=>{try{window._AMapSecurityConfig={securityJsCode:ca};const a=await na.load({key:pa,version:"2.0",plugins:["AMap.Geocoder"]});k=new a.Geocoder,h.value.length>0&&h.value.forEach(e=>Q(e))}catch(a){console.error("地图加载失败",a)}},Q=a=>m[a.id]?m[a.id]:a.lat&&a.lng&&k?(m[a.id]||(m[a.id]="定位中..."),k.getAddress([a.lng,a.lat],(e,i)=>{e==="complete"&&i.regeocode?m[a.id]=i.regeocode.formattedAddress:m[a.id]="地址解析失败"}),m[a.id]):a.city||"暂无位置信息",ue=async()=>{try{const a=await oa({current:1,pageSize:1e3});K.value=a.data.records}catch(a){console.error("获取商户列表失败",a)}},v=async()=>{D.value=!0;try{const a=await aa(s);h.value=a.data.records,H.value=typeof a.data.total=="string"?parseInt(a.data.total):a.data.total,k||await J(),setTimeout(()=>{k&&h.value.forEach(e=>Q(e))},500)}finally{D.value=!1}},T=a=>{if(a.imageUrl)return a.imageUrl;if(a.mediaList&&Array.isArray(a.mediaList)&&a.mediaList.length>0){const e=a.mediaList.find(i=>i.mediaType==="image");return e?e.mediaUrl:""}return""},B=()=>{s.current=1,v()},pe=()=>{s.name="",s.city="",s.category="",B()},W=async(a,e)=>{if(await ue(),z.value=a,C.value=!0,L.value=null,a==="edit"&&e){Object.assign(o,e),o.openStatus=e.openStatus||"open",o.imageUrl||(o.imageUrl=T(e));try{const i=await se(e.id);o.merchantIds=i.data?i.data.map(d=>d.id):[]}catch(i){console.error("获取关联商户失败",i),o.merchantIds=[]}}else o.id=void 0,o.name="",o.category="",o.city="",o.description="",o.imageUrl="",o.isIndoor=0,o.openStatus="open",o.lat=void 0,o.lng=void 0,o.merchantIds=[]},ce=a=>{a.raw&&(L.value=a.raw,o.imageUrl=URL.createObjectURL(a.raw))},me=async()=>{j.value&&await j.value.validate(async a=>{if(a){R.value=!0;try{const e=new FormData;e.append("name",o.name||""),e.append("category",o.category||""),e.append("description",o.description||""),e.append("city",o.city||""),e.append("openStatus",o.openStatus||"open"),o.lat!==void 0&&o.lat!==null&&e.append("lat",String(o.lat)),o.lng!==void 0&&o.lng!==null&&e.append("lng",String(o.lng)),e.append("isIndoor",String(o.isIndoor)),o.merchantIds&&o.merchantIds.length>0?e.append("merchantIds",o.merchantIds.join(",")):e.append("merchantIds",""),L.value&&e.append("images",L.value),z.value==="add"?(await ta(e),b.success("新增成功")):(await de(o.id,e),b.success("更新成功")),C.value=!1,v()}catch(e){console.error(e),b.error(e.message||"操作失败")}finally{R.value=!1}}})},fe=a=>{We.confirm(`确定删除 "${a.name}" 吗？`,"警告",{type:"warning",confirmButtonText:"确定",cancelButtonText:"取消"}).then(async()=>{await la(a.id),b.success("删除成功"),v()})},ge=async a=>{S.value={...a},I.value=!0,U.value=[],a.mediaList&&a.mediaList.length>0?g.value=a.mediaList.filter(e=>e.mediaType==="image").map(e=>({name:String(e.id),url:e.mediaUrl,id:e.id})):g.value=[];try{const e=await se(a.id),i=e.data?e.data.map(d=>d.id):[];S.value.merchantIds=i}catch(e){console.error("资源管理：获取关联商户失败",e),S.value.merchantIds=[]}},ve=(a,e)=>{const i=a;i.id&&U.value.push(String(i.id)),g.value=e},ye=(a,e)=>{g.value=e},_e=async()=>{const a=S.value;if(a.id){M.value=!0;try{const e=new FormData;e.append("name",a.name||""),e.append("category",a.category||""),e.append("city",a.city||""),e.append("description",a.description||""),e.append("isIndoor",String(a.isIndoor===void 0?0:a.isIndoor)),e.append("openStatus",a.openStatus||"open"),a.lat!==void 0&&a.lat!==null&&e.append("lat",String(a.lat)),a.lng!==void 0&&a.lng!==null&&e.append("lng",String(a.lng)),a.merchantIds&&a.merchantIds.length>0?e.append("merchantIds",a.merchantIds.join(",")):e.append("merchantIds",""),U.value.length>0&&e.append("deleteMediaIds",U.value.join(","));const i=g.value.filter(d=>!d.id&&d.raw);if(i.forEach(d=>{e.append("images",d.raw)}),U.value.length===0&&i.length===0){b.info("未检测到图片变更"),I.value=!1,M.value=!1;return}await de(a.id,e),b.success("资源更新成功"),I.value=!1,v()}catch(e){console.error(e),b.error(e.message||"更新失败")}finally{M.value=!1}}},be=a=>{s.current=a,v()},Ie=a=>{s.pageSize=a,s.current=1,v()};return Ee(()=>{J(),v()}),(a,e)=>{const i=Me,d=Le,E=Ze,w=De,p=ze,X=Ae,Z=we,y=Be,F=Oe,Ve=Fe,ee=$e,he=Xe,Ce=He,ae=Ke,te=Ye,Se=Ne,P=Qe,le=Je,ne=xe,Ue=Te;return c(),_("div",ia,[l(Z,{shadow:"never",class:"search-card"},{default:n(()=>[l(X,{inline:!0,model:s},{default:n(()=>[l(d,{label:"项目名称"},{default:n(()=>[l(i,{modelValue:s.name,"onUpdate:modelValue":e[0]||(e[0]=t=>s.name=t),placeholder:"支持模糊搜索",clearable:"",onKeyup:Pe(B,["enter"])},null,8,["modelValue"])]),_:1}),l(d,{label:"类别"},{default:n(()=>[l(w,{modelValue:s.category,"onUpdate:modelValue":e[1]||(e[1]=t=>s.category=t),placeholder:"全部",clearable:"",style:{width:"140px"}},{default:n(()=>[(c(),_(x,null,A(N,t=>l(E,{key:t,label:t,value:t},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1}),l(d,{label:"城市"},{default:n(()=>[l(w,{modelValue:s.city,"onUpdate:modelValue":e[2]||(e[2]=t=>s.city=t),placeholder:"全部",clearable:"",style:{width:"140px"}},{default:n(()=>[(c(),_(x,null,A(Y,t=>l(E,{key:t,label:t,value:t},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1}),l(d,null,{default:n(()=>[l(p,{type:"primary",icon:f(Re),onClick:B},{default:n(()=>[...e[18]||(e[18]=[r("搜索",-1)])]),_:1},8,["icon"]),l(p,{onClick:pe},{default:n(()=>[...e[19]||(e[19]=[r("重置",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1}),l(Z,{shadow:"never"},{default:n(()=>[V("div",da,[l(p,{type:"primary",icon:f($),onClick:e[3]||(e[3]=t=>W("add"))},{default:n(()=>[...e[20]||(e[20]=[r("新增非遗项目",-1)])]),_:1},8,["icon"])]),je((c(),q(he,{data:h.value,border:"",stripe:""},{default:n(()=>[l(y,{prop:"id",label:"ID",width:"80",align:"center"}),l(y,{label:"封面",width:"100",align:"center"},{default:n(({row:t})=>[l(Ve,{style:{width:"60px",height:"60px","border-radius":"4px"},src:T(t),fit:"cover","preview-src-list":[T(t)],"preview-teleported":""},{error:n(()=>[V("div",sa,[l(F,null,{default:n(()=>[l(f(ie))]),_:1})])]),_:1},8,["src","preview-src-list"])]),_:1}),l(y,{prop:"name",label:"项目名称","min-width":"200","show-overflow-tooltip":""}),l(y,{prop:"category",label:"类别",width:"120",align:"center"},{default:n(({row:t})=>[l(ee,null,{default:n(()=>[r(G(t.category),1)]),_:2},1024)]),_:1}),l(y,{label:"城市/位置",width:"200","show-overflow-tooltip":""},{default:n(({row:t})=>[V("span",null,G(m[t.id]||t.city||"加载中..."),1)]),_:1}),l(y,{label:"场所类型",width:"100",align:"center"},{default:n(({row:t})=>[l(ee,{type:t.isIndoor?"warning":"success",effect:"plain"},{default:n(()=>[r(G(t.isIndoor?"室内":"室外"),1)]),_:2},1032,["type"])]),_:1}),l(y,{label:"操作",width:"280",fixed:"right",align:"center"},{default:n(({row:t})=>[l(p,{link:"",type:"primary",icon:f(qe),onClick:oe=>W("edit",t)},{default:n(()=>[...e[21]||(e[21]=[r("编辑",-1)])]),_:1},8,["icon","onClick"]),l(p,{link:"",type:"success",icon:f(ie),onClick:oe=>ge(t)},{default:n(()=>[...e[22]||(e[22]=[r("资源管理",-1)])]),_:1},8,["icon","onClick"]),l(p,{link:"",type:"danger",icon:f(Ge),onClick:oe=>fe(t)},{default:n(()=>[...e[23]||(e[23]=[r("删除",-1)])]),_:1},8,["icon","onClick"])]),_:1})]),_:1},8,["data"])),[[Ue,D.value]]),V("div",ra,[l(Ce,{"current-page":s.current,"onUpdate:currentPage":e[4]||(e[4]=t=>s.current=t),"page-size":s.pageSize,"onUpdate:pageSize":e[5]||(e[5]=t=>s.pageSize=t),total:H.value,"page-sizes":[10,20,50],layout:"total, sizes, prev, pager, next, jumper",onCurrentChange:be,onSizeChange:Ie},null,8,["current-page","page-size","total"])])]),_:1}),l(ne,{modelValue:C.value,"onUpdate:modelValue":e[14]||(e[14]=t=>C.value=t),title:z.value==="add"?"新增项目":"编辑项目",width:"600px"},{footer:n(()=>[l(p,{onClick:e[13]||(e[13]=t=>C.value=!1)},{default:n(()=>[...e[29]||(e[29]=[r("取消",-1)])]),_:1}),l(p,{type:"primary",loading:R.value,onClick:me},{default:n(()=>[...e[30]||(e[30]=[r("保存",-1)])]),_:1},8,["loading"])]),default:n(()=>[l(X,{ref_key:"formRef",ref:j,model:o,rules:re,"label-width":"100px"},{default:n(()=>[l(d,{label:"项目名称",prop:"name"},{default:n(()=>[l(i,{modelValue:o.name,"onUpdate:modelValue":e[6]||(e[6]=t=>o.name=t),placeholder:"如：广绣"},null,8,["modelValue"])]),_:1}),l(d,{label:"项目封面"},{default:n(()=>[l(ae,{class:"avatar-uploader",action:"#","show-file-list":!1,"auto-upload":!1,"on-change":ce,accept:"image/*"},{default:n(()=>[o.imageUrl?(c(),_("img",{key:0,src:o.imageUrl,class:"avatar"},null,8,ua)):(c(),q(F,{key:1,class:"avatar-uploader-icon"},{default:n(()=>[l(f($))]),_:1}))]),_:1}),e[24]||(e[24]=V("div",{class:"tips"},"点击上传新封面 (将在保存时提交)",-1))]),_:1}),l(d,{label:"关联商户"},{default:n(()=>[l(w,{modelValue:o.merchantIds,"onUpdate:modelValue":e[7]||(e[7]=t=>o.merchantIds=t),multiple:"",placeholder:"请选择关联商户",style:{width:"100%"}},{default:n(()=>[(c(!0),_(x,null,A(K.value,t=>(c(),q(E,{key:t.id,label:t.name,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),l(Se,{gutter:20},{default:n(()=>[l(te,{span:14},{default:n(()=>[l(d,{label:"类别",prop:"category"},{default:n(()=>[l(w,{modelValue:o.category,"onUpdate:modelValue":e[8]||(e[8]=t=>o.category=t),style:{width:"100%"}},{default:n(()=>[(c(),_(x,null,A(N,t=>l(E,{key:t,label:t,value:t},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1})]),_:1}),l(te,{span:12},{default:n(()=>[l(d,{label:"城市",prop:"city"},{default:n(()=>[l(w,{modelValue:o.city,"onUpdate:modelValue":e[9]||(e[9]=t=>o.city=t),style:{width:"100%"}},{default:n(()=>[(c(),_(x,null,A(Y,t=>l(E,{key:t,label:t,value:t},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),l(d,{label:"场所属性"},{default:n(()=>[l(le,{modelValue:o.isIndoor,"onUpdate:modelValue":e[10]||(e[10]=t=>o.isIndoor=t)},{default:n(()=>[l(P,{label:0},{default:n(()=>[...e[25]||(e[25]=[r("室外",-1)])]),_:1}),l(P,{label:1},{default:n(()=>[...e[26]||(e[26]=[r("室内",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1}),l(d,{label:"开放状态"},{default:n(()=>[l(le,{modelValue:o.openStatus,"onUpdate:modelValue":e[11]||(e[11]=t=>o.openStatus=t)},{default:n(()=>[l(P,{label:"open"},{default:n(()=>[...e[27]||(e[27]=[r("开放",-1)])]),_:1}),l(P,{label:"close"},{default:n(()=>[...e[28]||(e[28]=[r("关闭",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1}),l(d,{label:"项目描述"},{default:n(()=>[l(i,{modelValue:o.description,"onUpdate:modelValue":e[12]||(e[12]=t=>o.description=t),type:"textarea",rows:4,placeholder:"请输入项目简介..."},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),l(ne,{modelValue:I.value,"onUpdate:modelValue":e[17]||(e[17]=t=>I.value=t),title:`资源管理 - ${S.value.name}`,width:"700px"},{footer:n(()=>[l(p,{onClick:e[16]||(e[16]=t=>I.value=!1)},{default:n(()=>[...e[31]||(e[31]=[r("取消",-1)])]),_:1}),l(p,{type:"primary",loading:M.value,onClick:_e},{default:n(()=>[...e[32]||(e[32]=[r("保存更改",-1)])]),_:1},8,["loading"])]),default:n(()=>[e[33]||(e[33]=V("div",{style:{"margin-bottom":"10px",color:"#666","font-size":"14px"}}," 管理该非遗项目的图片资源。新上传的图片将在点击“保存更改”后提交。 ",-1)),l(ae,{"file-list":g.value,"onUpdate:fileList":e[15]||(e[15]=t=>g.value=t),action:"#","list-type":"picture-card","auto-upload":!1,"on-remove":ve,"on-change":ye,accept:"image/*",multiple:""},{default:n(()=>[l(F,null,{default:n(()=>[l(f($))]),_:1})]),_:1},8,["file-list"])]),_:1},8,["modelValue","title"])])}}}),Ua=ea(ma,[["__scopeId","data-v-daddf4e8"]]);export{Ua as default};
